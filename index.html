<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Rol</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>
<body onload="openTab('load')">
    <div class="container">

        <h1>D&D - El Señor de los Anillos</h1>

        <div class="tabs">
            <div class="tab" onclick="openTab('characters')">Personajes</div>
            <div class="tab" onclick="openTab('editCharacter')">Editar</div>
            <div class="tab" onclick="openTab('enemies')">Enemigos</div>
            <div class="tab" onclick="openTab('combat')">Combate</div>
            <div class="tab" onclick="openTab('skills')">Habilidades</div>
            <div class="tab" onclick="openTab('items')">Objetos</div>
            <div class="tab" onclick="openTab('exp')">Niveles</div>
            <div class="tab" onclick="openTab('map')">Mapa</div>
            <div class="tab" onclick="openTab('load')">Datos</div>
        </div>

        <!--PESTAÑA DE PERSONAJES-->
        <div id="characters" class="content active">
            <div id="characterContainer" class="character-container"></div>
            <div class="character-actions">
                <button id="saveGameButton" onclick="saveGame()">Guardar Partida</button>
                <button id="copyToClipboardButton" onclick="copyToClipboard()">Copiar al Portapapeles</button>
            </div>
        </div>

        <div id="combat" class="content">
            <h2>Combate</h2>
            <!-- Botón para abrir la ventana de recompensas -->
            <button id="generateRewardButton" onclick="openRewardPopup()">Generar Recompensas</button>

            <div id="rewardPopup" class="reward-popup hidden">
                <div class="reward-popup-content">
                    <span class="close" onclick="closeRewardPopup()">&times;</span>
                    <h2>Generar Recompensas</h2>
                    <form id="rewardForm">
                        <div class="form-group">
                            <label for="playerLevel">Nivel de los Jugadores:</label>
                            <input type="number" id="playerLevel" name="playerLevel" min="1" max="20" required>
                        </div>
                        <div class="form-group">
                            <label for="enemiesDefeated">Enemigos Derrotados:</label>
                            <input type="number" id="enemiesDefeated" name="enemiesDefeated" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="isBoss">Jefe:</label>
                            <input type="checkbox" id="isBoss" name="isBoss">
                        </div>
                        <button type="button" class="generate-button" onclick="generateRewards()">Generar</button>
                    </form>
                    <div id="rewardResults" class="reward-results"></div>
                </div>
            </div>
            

            <div class="combat-container">
                <div class="combat-select">
                    <label for="characterSelect">Personaje:</label>
                    <select id="characterSelect" onchange="loadCharacterStats()">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <!-- Botón para actualizar personajes -->
                    <p>Tras finalizar el combate, genera la recompensa y actualiza tu personaje para guardar su progreso.</p>
                    <button id="updateCharacterButton" class="buttonUpdateChar" onclick="updateCharacterData()">Actualizar Personaje</button>
                </div>
                <div class="combat-stats" id="characterStats">
                    <!-- Character stats will be displayed here -->
                </div>
                <div class="combat-select">
                    <label for="enemySelect">Enemigo:</label>
                    <select id="enemySelect" onchange="loadEnemyStats()">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="combat-stats" id="enemyStats">
                    <!-- Enemy stats will be displayed here -->
                </div>
            </div>
            

        </div>

        <div id="enemies" class="content">
            <div id="enemyContainer" class="enemy-container"></div>
        </div>
        <div id="load" class="content">
            <input type="file" id="fileInput" accept=".json" onchange="loadFile()" />
            <p>Selecciona el fichero JSON o pégalo directamente.</p>
            <textarea id="jsonInput" placeholder="Pega aquí el JSON..."></textarea>
            <button onclick="loadData()">Cargar Datos</button>
        </div>

        <!-- EDITAR PERSONAJES -->
        <div id="editCharacter" class="content">
            <h2>Editar Personaje</h2>
            <div class="edit-container">
                <!-- Select para elegir el personaje -->
                <label for="editCharacterSelect">Seleccionar Personaje:</label>
                <select id="editCharacterSelect" onchange="loadCharacterForEditing()">
                    <!-- Las opciones se llenarán dinámicamente -->
                </select>

                <!-- Formulario de edición del personaje -->
                <div id="editCharacterForm">
                    <h3>Información del Personaje</h3>
                    <div class="form-group">
                        <label for="editCharacterName">Nombre:</label>
                        <input type="text" id="editCharacterName" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterImage">Imagen (URL):</label>
                        <input type="text" id="editCharacterImage" placeholder="URL de la imagen" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterLevel">Nivel:</label>
                        <input type="number" id="editCharacterLevel" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterGender">Género:</label>
                        <input type="text" id="editCharacterGender" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterRace">Raza:</label>
                        <input type="text" id="editCharacterRace" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterClass">Clase:</label>
                        <input type="text" id="editCharacterClass" />
                    </div>

                    <h3>Estadísticas</h3>
                    <div class="form-group">
                        <label for="editCharacterVIT">VIT:</label>
                        <input type="number" id="editCharacterVIT" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterFUE">FUE:</label>
                        <input type="number" id="editCharacterFUE" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterDES">DES:</label>
                        <input type="number" id="editCharacterDES" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterINT">INT:</label>
                        <input type="number" id="editCharacterINT" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterCAR">CAR:</label>
                        <input type="number" id="editCharacterCAR" />
                    </div>

                    <h3>Inventario</h3>
                    <div class="form-group">
                        <label for="editCharacterGold">Oro:</label>
                        <input type="number" id="editCharacterGold" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterItems">Objetos:</label>
                        <textarea id="editCharacterItems"></textarea>
                    </div>

                    <h3>Experiencia</h3>
                    <div class="form-group">
                        <label for="editCharacterXP">XP:</label>
                        <input type="number" id="editCharacterXP" />
                    </div>

                    <button class="save-button" onclick="saveCharacterChanges()">Guardar Cambios</button>
                </div>
            </div>
        </div>

        

        <!--SKILLS -->
        <div id="skills" class="content">
            <!--FILTERS-->
            <div class="filters">
				<select id="skillFilter" onchange="filterSkills()">
					<option value="all">-Clase-</option>
                    <option value="Guerrero">Guerrero</option>
                    <option value="Explorador">Explorador</option>
                    <option value="Pícaro">Pícaro</option>
                    <option value="Hechicero">Hechicero</option>
                    <option value="Paladín">Paladín</option>
                    <option value="Druida">Druida</option>
                    <option value="Clérigo">Clérigo</option>
                    <option value="Bardo">Bardo</option>
				</select>
                <button class="reset-button" onclick="resetFiltersSkills()">Restablecer Filtros</button>
            </div>

            <!--TABLE-->
            <table id="skillsTable">
                <thead>
                    <tr>
                        <th>Nombre de la habilidad</th>
                        <th>Descripción</th>
                        <th>Nivel</th>
                        <th>Clase</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!--FIN SKILLS-->

        <!--ITEMS-->
        <div id="items" class="content">
			<div class="filters">
				<select id="itemFilter" onchange="filterItems()">
					<option value="all">-Tipo de objeto-</option>
					<option value="Poción">Poción</option>
					<option value="Arma">Arma</option>
					<option value="Armadura">Armadura</option>

                    <option value="Cabeza">Cabeza</option>
                    <option value="Brazales">Brazales</option>
                    <option value="Guantes">Guantes</option>
                    <option value="Cinturón">Cinturón</option>
                    <option value="Botas">Botas</option>

					<option value="Para vender">Para vender</option>
				</select>
				<select id="levelFilter" onchange="filterItems()">
					<option value="all">-Nivel-</option>
					<option value="1">Nivel 1</option>
					<option value="10">Nivel 10</option>
					<option value="15">Nivel 15</option>
					<option value="20">Nivel 20</option>
					<!-- Añadir más niveles según sea necesario -->
				</select>
				<select id="classFilter" onchange="filterItems()">
					<option value="all">-Clase-</option>
					<option value="Todos">Todos</option>
					<option value="Guerrero">Guerrero</option>
					<option value="Explorador">Explorador</option>
					<option value="Hechicero">Hechicero</option>
					<option value="Pícaro">Pícaro</option>
					<option value="Paladín">Paladín</option>
					<option value="Bardo">Bardo</option>
					<option value="Clérigo">Clérigo</option>
					<option value="Druida">Druida</option>
					<!-- Añadir más clases según sea necesario -->
				</select>
				<button class="reset-button" onclick="resetFilters()">Restablecer Filtros</button>
			</div>
			
            <table id="itemsTable">
				<thead>
					<tr>
						<th>Nombre del objeto</th>
						<th>Descripción</th>
						<th>Tipo de objeto</th>
						<th>Precio (Oro)</th>
						<th>Nivel</th>
						<th>Clase</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
        </div>
        <!--FIN ITEMS-->

        <!--NIVELES -->
        <div id="exp" class="content">
            <!--TABLE-->
            <table id="expTable">
                <thead>
                    <tr>
                        <th>Nivel</th>
                        <th>Experiencia Total</th>
                        <th>Incremento de Experiencia</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!--FIN NIVELES-->

        <!--MAP-->

        <div id="map" class="content">
            <h2>Mapa de la Tierra Media</h2>
            <div id="mapContainer" class="map-container">
                <p>Haz click sobre el mapa para insertar una marca.</p>
                <button onclick="clearMarkers()" class="reset-button">Borrar Marcas</button>
                <img src="https://tierramedia.net/wp-content/uploads/mapa-tierra-media-16.jpg" id="mapImage" alt="Mapa de la Tierra Media">
            </div>
        </div>
    </div>

    <script>

        let charactersData = [];
        let enemiesData = [];
        let skillsLoaded = false; // Variable para controlar la carga de habilidades
        let itemsLoaded = false; // Variable para controlar si los datos de los objetos ya se han cargado

        function openTab(tabName) {
            // Remover la clase 'active' de todos los contenidos
            const contents = document.getElementsByClassName("content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].classList.remove("active");
            }

            // Mostrar el contenido correspondiente
            document.getElementById(tabName).classList.add("active");

            // Remover la clase 'active' de todas las pestañas
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }

            // Buscar la pestaña activa y añadir la clase 'active'
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].getAttribute('onclick').includes(tabName)) {
                    tabs[i].classList.add("active");
                }
            }

            // Cargar datos específicos según la pestaña
            if (tabName === 'items') {
                if (!itemsLoaded) {
                    loadItems();
                } else {
                    filterItems(); // Aplicamos el filtro actual al volver a la pestaña
                }
            }
            if (tabName === 'skills') {
                if (!skillsLoaded) { // Verificamos si ya hemos cargado las habilidades
                    loadSkills();
                } else {
                    filterSkills(); // Aplicamos el filtro actual al volver a la pestaña
                }
            }
            if (tabName === 'exp') {
                loadExp();
            }
        }

        document.getElementById('mapImage').addEventListener('click', function(event) {
            var mapContainer = document.getElementById('mapContainer');
            var rect = mapContainer.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;

            var marker = document.createElement('div');
            marker.classList.add('marker');
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            mapContainer.appendChild(marker);
        });

        function clearMarkers() {
            var mapContainer = document.getElementById('mapContainer');
            var markers = document.getElementsByClassName('marker');
            while (markers.length > 0) {
                markers[0].parentNode.removeChild(markers[0]);
            }
        }
        
        // Función para guardar la partida como un archivo JSON
        function saveGame() {
            // Convertir los datos de los personajes a JSON
            const jsonData = JSON.stringify({ characters: charactersData }, null, 2);

            // Crear un blob de tipo JSON
            const blob = new Blob([jsonData], { type: 'application/json' });

            // Crear un enlace de descarga
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'savegame.json';
            a.click();

            // Liberar el objeto URL
            URL.revokeObjectURL(url);

            alert('Partida guardada exitosamente como savegame.json');
        }

        // Función para copiar los datos de los personajes al portapapeles
        function copyToClipboard() {
            const jsonData = JSON.stringify({ characters: charactersData }, null, 2);

            // Utilizar la API del portapapeles
            navigator.clipboard.writeText(jsonData).then(() => {
                alert('Datos copiados al portapapeles');
            }).catch(err => {
                console.error('Error al copiar al portapapeles:', err);
                alert('Error al copiar al portapapeles');
            });
        }

        // Función para cargar los datos de savegame.json al cargar la página
        function loadSavedGame() {
            fetch('savegame.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se encontró el archivo savegame.json');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.characters) {
                        charactersData = data.characters;
                        loadCharacterData();
                        alert('Partida cargada exitosamente desde savegame.json');
                    }
                })
                .catch(error => {
                    console.error('Error al cargar la partida:', error);
                    // Opcional: Mostrar un mensaje si el archivo no existe
                    // alert('No se encontró un archivo de partida guardada.');
                });
        }

        // Llamar a la función al cargar la página
        window.onload = function() {
            loadSavedGame();
            openTab('load'); // Mantener el comportamiento original de abrir la pestaña de carga
        };

        // Cargar datos del JSON

        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    document.getElementById('jsonInput').value = content;
                };
                reader.readAsText(file);
            } else {
                alert("Por favor, selecciona un archivo.");
            }
        }

        function loadData() {
            const jsonInput = document.getElementById('jsonInput').value;
            const characterContainer = document.getElementById('characterContainer');
            const enemyContainer = document.getElementById('enemyContainer');
            characterContainer.innerHTML = ''; // Limpiar contenido existente
            enemyContainer.innerHTML = ''; // Limpiar contenido existente

            try {
                const data = JSON.parse(jsonInput);

                // Verificar que los datos de personajes existan
                if (!data.characters || !Array.isArray(data.characters)) {
                    throw new Error('No se encontraron datos de personajes o el formato es incorrecto.');
                }

                // Guardar datos de personajes para uso posterior
                charactersData = data.characters;
                console.log("Datos de personajes cargados:", charactersData);

                // Poblar el contenedor de personajes
                data.characters.forEach(character => {
                    const characterDiv = document.createElement('div');
                    characterDiv.className = 'character';

                    // Construir la lista de objetos
                    const itemsList = character.inventory.items.map(item => `<li>${item}</li>`).join('');

                    const characterInfo = `
                        <img src="${character.image}" alt="${character.name}">
                        <h2>${character.name}</h2>
                        <h3>Nivel: ${character.level}</h3>
                        <p><strong>Género:</strong> ${character.gender}</p>
                        <p><strong>Raza:</strong> ${character.race}</p>
                        <p><strong>Clase:</strong> ${character.class}</p>
                        <h3>Estadísticas</h3>
                        <ul class="stats">
                            <li><strong>VIT:</strong> ${character.stats.VIT}</li>
                            <li><strong>FUE:</strong> ${character.stats.FUE}</li>
                            <li><strong>DES:</strong> ${character.stats.DES}</li>
                            <li><strong>INT:</strong> ${character.stats.INT}</li>
                            <li><strong>CAR:</strong> ${character.stats.CAR}</li>
                        </ul>
                        <h3>Inventario</h3>
                        <ul class="inventory">
                            <li><strong>Oro:</strong> ${character.inventory.gold}</li>
                            <li><strong>Objetos:</strong><ul>${itemsList}</ul></li>
                        </ul>
                        <h3>Experiencia</h3>
                        <p>${character.xp}</p>
                    `;

                    characterDiv.innerHTML = characterInfo;
                    characterContainer.appendChild(characterDiv);
                });

                // Verificar si existen datos de enemigos y manejarlos
                if (data.enemies && Array.isArray(data.enemies)) {
                    // Guardar datos de enemigos para uso posterior
                    enemiesData = data.enemies;
                    console.log("Datos de enemigos cargados:", enemiesData);

                    // Poblar el contenedor de enemigos
                    data.enemies.forEach(enemy => {
                        const enemyDiv = document.createElement('div');
                        enemyDiv.className = 'enemy';

                        const enemyInfo = `
                            <h2>${enemy.name}</h2>
                            <h3>Estadísticas</h3>
                            <ul class="stats">
                                <li><strong>VIT:</strong> ${enemy.stats.VIT}</li>
                                <li><strong>FUE:</strong> ${enemy.stats.FUE}</li>
                                <li><strong>DES:</strong> ${enemy.stats.DES}</li>
                                <li><strong>INT:</strong> ${enemy.stats.INT}</li>
                                <li><strong>CAR:</strong> ${enemy.stats.CAR}</li>
                            </ul>
                        `;

                        enemyDiv.innerHTML = enemyInfo;
                        enemyContainer.appendChild(enemyDiv);
                    });
                } else {
                    console.warn('No se encontraron datos de enemigos o el formato es incorrecto.');
                    enemiesData = []; // Inicializar con una lista vacía si no hay enemigos
                }

                // Poblar los selects en la pestaña de combate
                populateCombatSelects();

                openTab('characters'); // Cambia a la pestaña de personajes como predeterminada
                populateEditCharacterSelect();
            } catch (error) {
                console.error('Error al cargar el JSON:', error);
                alert('JSON inválido. Por favor, verifica el formato e inténtalo nuevamente.');
            }
        }


        //EDITAR INFO DE LOS PERSONAJES:

        // Función para cargar los personajes en el select de edición
        function populateEditCharacterSelect() {
            const editCharacterSelect = document.getElementById('editCharacterSelect');
            editCharacterSelect.innerHTML = charactersData.map(character => `<option value="${character.name}">${character.name}</option>`).join('');

            if (charactersData.length > 0) {
                editCharacterSelect.value = charactersData[0].name;
                loadCharacterForEditing(); // Cargar el primer personaje por defecto
            }
        }

        // Función para cargar los datos del personaje seleccionado en el formulario de edición
        // Función para cargar los datos del personaje seleccionado en el formulario de edición
        function loadCharacterForEditing() {
            const selectedName = document.getElementById('editCharacterSelect').value;
            const character = charactersData.find(c => c.name === selectedName);

            if (character) {
                document.getElementById('editCharacterName').value = character.name;
                document.getElementById('editCharacterImage').value = character.image; // Cargar URL de la imagen
                document.getElementById('editCharacterLevel').value = character.level;
                document.getElementById('editCharacterGender').value = character.gender;
                document.getElementById('editCharacterRace').value = character.race;
                document.getElementById('editCharacterClass').value = character.class;
                document.getElementById('editCharacterVIT').value = character.stats.VIT;
                document.getElementById('editCharacterFUE').value = character.stats.FUE;
                document.getElementById('editCharacterDES').value = character.stats.DES;
                document.getElementById('editCharacterINT').value = character.stats.INT;
                document.getElementById('editCharacterCAR').value = character.stats.CAR;
                document.getElementById('editCharacterGold').value = character.inventory.gold;
                document.getElementById('editCharacterItems').value = character.inventory.items.join(', ');
                document.getElementById('editCharacterXP').value = character.xp;
            } else {
                console.warn('Personaje no encontrado para editar:', selectedName);
            }
        }

        // Función para guardar los cambios realizados en el personaje
        function saveCharacterChanges() {
            const selectedName = document.getElementById('editCharacterSelect').value;
            const character = charactersData.find(c => c.name === selectedName);

            if (character) {
                // Actualizar los datos del personaje
                const newName = document.getElementById('editCharacterName').value;
                character.name = newName;
                character.image = document.getElementById('editCharacterImage').value; // Actualizar la URL de la imagen
                character.level = parseInt(document.getElementById('editCharacterLevel').value);
                character.gender = document.getElementById('editCharacterGender').value;
                character.race = document.getElementById('editCharacterRace').value;
                character.class = document.getElementById('editCharacterClass').value;
                character.stats.VIT = parseInt(document.getElementById('editCharacterVIT').value);
                character.stats.FUE = parseInt(document.getElementById('editCharacterFUE').value);
                character.stats.DES = parseInt(document.getElementById('editCharacterDES').value);
                character.stats.INT = parseInt(document.getElementById('editCharacterINT').value);
                character.stats.CAR = parseInt(document.getElementById('editCharacterCAR').value);
                character.inventory.gold = parseInt(document.getElementById('editCharacterGold').value);

                // Actualizar los objetos del inventario y formatearlos como lista
                character.inventory.items = document.getElementById('editCharacterItems').value.split(',').map(item => item.trim());
                
                // Actualizar la experiencia
                character.xp = parseInt(document.getElementById('editCharacterXP').value);

                // Refrescar la vista de personajes y combate
                loadCharacterData();
                populateCombatSelects();
                populateEditCharacterSelect(); // Actualizar el select de personajes al cambiar el nombre

                // Seleccionar el nuevo nombre en el select de edición
                document.getElementById('editCharacterSelect').value = newName;

                alert('Cambios guardados exitosamente para el personaje: ' + character.name);
            } else {
                console.error('Error al guardar los cambios: personaje no encontrado.');
            }
        }


        // Llama a esta función después de cargar los datos
        window.onload = function() {
            loadSavedGame();
            openTab('load'); // Mantener el comportamiento original de abrir la pestaña de carga
            populateEditCharacterSelect(); // Poblamos el select al iniciar la aplicación
        };


        // Poblar los selects de personajes y enemigos en la pestaña de combate
        function populateCombatSelects() {
            const characterSelect = document.getElementById('characterSelect');
            const enemySelect = document.getElementById('enemySelect');

            characterSelect.innerHTML = charactersData.map(character => `<option value="${character.name}">${character.name}</option>`).join('');
            enemySelect.innerHTML = enemiesData.map(enemy => `<option value="${enemy.name}">${enemy.name}</option>`).join('');

            // Si hay personajes, carga el primero
            if (charactersData.length > 0) {
                characterSelect.value = charactersData[0].name;
                loadCharacterStats();
            }

            // Si hay enemigos, carga el primero
            if (enemiesData.length > 0) {
                enemySelect.value = enemiesData[0].name;
                loadEnemyStats();
            }
        }

        function updateCharacterData() {
            // Obtener el personaje seleccionado
            const characterName = document.getElementById('characterSelect').value;
            const character = charactersData.find(c => c.name === characterName);

            if (!character) {
                alert('Por favor, selecciona un personaje para actualizar.');
                return;
            }

            // Obtener las recompensas generadas
            const rewardResults = document.getElementById('rewardResults');

            // Variables para almacenar experiencia, oro y objetos de recompensas
            let expGain = 0;
            let goldGain = 0;
            let items = [];

            // Solo procesar recompensas si existen
            if (rewardResults.innerHTML) {
                // Extraer experiencia, oro y objetos de las recompensas
                const expRegex = /(\d+) EXP/;
                const goldRegex = /(\d+) de oro/;
                const itemsRegex = /<li>(.*?) - Nivel:/g;

                const expMatch = expRegex.exec(rewardResults.innerHTML);
                const goldMatch = goldRegex.exec(rewardResults.innerHTML);
                let itemsMatch;

                while ((itemsMatch = itemsRegex.exec(rewardResults.innerHTML)) !== null) {
                    items.push(itemsMatch[1]);
                }

                expGain = expMatch ? parseInt(expMatch[1], 10) : 0;
                goldGain = goldMatch ? parseInt(goldMatch[1], 10) : 0;
            }

            // Actualizar estadísticas del personaje
            character.xp += expGain;
            character.inventory.gold += goldGain;
            character.inventory.items = [...character.inventory.items, ...items];

            // Actualizar otros datos del personaje
            const characterStats = document.getElementById('characterStats');
            character.stats.VIT = parseInt(document.getElementById('character-VIT').value) || character.stats.VIT;
            character.stats.FUE = parseInt(document.getElementById('character-FUE').value) || character.stats.FUE;
            character.stats.DES = parseInt(document.getElementById('character-DES').value) || character.stats.DES;
            character.stats.INT = parseInt(document.getElementById('character-INT').value) || character.stats.INT;
            character.stats.CAR = parseInt(document.getElementById('character-CAR').value) || character.stats.CAR;

            // Refrescar la vista de personajes
            loadCharacterData();
            populateEditCharacterSelect();

            if (rewardResults.innerHTML) {
                alert(`Personaje ${character.name} actualizado con ${expGain} EXP, ${goldGain} de oro y ${items.length} objetos nuevos.`);
            } else {
                alert(`Personaje ${character.name} actualizado. No se generaron recompensas.`);
            }
        }


        // Función para refrescar la vista de personajes
        function loadCharacterData() {
            const characterContainer = document.getElementById('characterContainer');
            characterContainer.innerHTML = ''; // Limpiar contenido existente

            charactersData.forEach(character => {
                const characterDiv = document.createElement('div');
                characterDiv.className = 'character';

                // Construir la lista de objetos
                const itemsList = character.inventory.items.map(item => `<li>${item}</li>`).join('');

                const characterInfo = `
                    <img src="${character.image}" alt="${character.name}">
                    <h2>${character.name}</h2>
                    <h3>Nivel: ${character.level}</h3>
                    <p><strong>Género:</strong> ${character.gender}</p>
                    <p><strong>Raza:</strong> ${character.race}</p>
                    <p><strong>Clase:</strong> ${character.class}</p>
                    <h3>Estadísticas</h3>
                    <ul class="stats">
                        <li><strong>VIT:</strong> ${character.stats.VIT}</li>
                        <li><strong>FUE:</strong> ${character.stats.FUE}</li>
                        <li><strong>DES:</strong> ${character.stats.DES}</li>
                        <li><strong>INT:</strong> ${character.stats.INT}</li>
                        <li><strong>CAR:</strong> ${character.stats.CAR}</li>
                    </ul>
                    <h3>Inventario</h3>
                    <ul class="inventory">
                        <li><strong>Oro:</strong> ${character.inventory.gold}</li>
                        <li><strong>Objetos:</strong><ul>${itemsList}</ul></li>
                    </ul>
                    <h3>Experiencia</h3>
                    <p>${character.xp}</p>
                `;

                characterDiv.innerHTML = characterInfo;
                characterContainer.appendChild(characterDiv);
            });
        }


        // Cargar estadísticas del personaje seleccionado
        function loadCharacterStats() {
            const characterName = document.getElementById('characterSelect').value;
            const character = charactersData.find(c => c.name === characterName);
            console.log("Personaje seleccionado:", characterName, character); // Log para verificar

            if (character) {
                document.getElementById('characterStats').innerHTML = generateStatsHtml(character, 'character');
            } else {
                document.getElementById('characterStats').innerHTML = '<p>No se encontró el personaje seleccionado.</p>';
            }
        }

        // Cargar estadísticas del enemigo seleccionado
        function loadEnemyStats() {
            const enemyName = document.getElementById('enemySelect').value;
            const enemy = enemiesData.find(e => e.name === enemyName);  // Encontrar enemigo por nombre
            console.log("Enemigo seleccionado:", enemyName, enemy);  // Log para verificar

            if (enemy) {
                document.getElementById('enemyStats').innerHTML = generateStatsHtml(enemy, 'enemy');
            } else {
                document.getElementById('enemyStats').innerHTML = '<p>No se encontró el enemigo seleccionado.</p>';
            }
        }

        // Generar HTML para las estadísticas
        function generateStatsHtml(entity, type) {
            // Comprobar si 'entity' es un personaje o enemigo y adaptar el HTML
            const statInputs = Object.keys(entity.stats).map(stat => {
                return `
                    <div>
                        <span>${stat}:</span>
                        <span id="${type}-${stat}-value">${entity.stats[stat]}</span>
                        <input type="number" class="stat-input" id="${type}-${stat}" placeholder="0">
                    </div>
                `;
            }).join('');

            return `
                <h3>${entity.name} - ${entity.class || 'Enemigo'}</h3>
                ${statInputs}
                <button class="update-button" onclick="updateStats('${entity.name}', '${type}')">Actualizar</button>
            `;
        }

        // Actualizar estadísticas
        function updateStats(name, type) {
            const entity = (type === 'character') ? charactersData.find(c => c.name === name) : enemiesData.find(e => e.name === name);
            console.log("Actualizando estadísticas para:", name, entity); // Log para verificar

            if (entity) {
                Object.keys(entity.stats).forEach(stat => {
                    const input = document.getElementById(`${type}-${stat}`);
                    const delta = parseInt(input.value) || 0;
                    entity.stats[stat] += delta;
                    document.getElementById(`${type}-${stat}-value`).innerText = entity.stats[stat];
                    input.value = ''; // Limpiar el campo de texto
                });
            } else {
                alert('Error: entidad no encontrada.');
            }
        }

        //----FUNCIONES PARA GENERAR RECOMEPNSAS ALEATORIAS-----
        document.addEventListener('DOMContentLoaded', function () {
            // Vincular eventos a botones
            const generateButton = document.getElementById('generateRewardButton');
            const closeButton = document.querySelector('.close');

            if (generateButton) {
                generateButton.addEventListener('click', openRewardPopup);
            } else {
                console.error("El botón de generar recompensas no se encontró.");
            }

            if (closeButton) {
                closeButton.addEventListener('click', closeRewardPopup);
            } else {
                console.error("El botón de cerrar no se encontró.");
            }
        });

        // Función para abrir la ventana de recompensas
        function openRewardPopup() {
            const rewardPopup = document.getElementById('rewardPopup');
            if (rewardPopup) {
                rewardPopup.classList.remove('hidden');
                rewardPopup.style.display = 'block'; // Asegúrate de que el display se cambie a block
            } else {
                console.error("No se pudo encontrar el elemento rewardPopup.");
            }
        }

        // Función para cerrar la ventana de recompensas
        function closeRewardPopup() {
            const rewardPopup = document.getElementById('rewardPopup');
            if (rewardPopup) {
                rewardPopup.classList.add('hidden');
                rewardPopup.style.display = 'none'; // Cambia display a none al cerrar
            } else {
                console.error("No se pudo encontrar el elemento rewardPopup.");
            }
        }


        // Función para generar recompensas aleatorias
        function generateRewards() {
            console.log("Función generateRewards llamada");

            const playerLevelInput = document.getElementById('playerLevel');
            const enemiesDefeatedInput = document.getElementById('enemiesDefeated');
            const isBossInput = document.getElementById('isBoss');

            if (!playerLevelInput || !enemiesDefeatedInput) {
                console.error("No se encontraron los elementos de entrada necesarios.");
                return;
            }

            const playerLevel = parseInt(playerLevelInput.value);
            const enemiesDefeated = parseInt(enemiesDefeatedInput.value);
            const isBoss = isBossInput.checked;

            if (isNaN(playerLevel) || isNaN(enemiesDefeated)) {
                alert("Por favor, ingrese valores válidos para el nivel del jugador y enemigos derrotados.");
                return;
            }

            // Cálculo de experiencia y oro
            const expPerEnemy = 75;
            const expBoss = 500;
            const goldPerEnemy = 25;
            const goldBoss = 250;

            let totalExp = enemiesDefeated * expPerEnemy;
            let totalGold = enemiesDefeated * goldPerEnemy;
            let numItems = Math.min(enemiesDefeated, 4); // Máximo de 4 objetos

            if (isBoss) {
                totalExp += expBoss;
                totalGold += goldBoss;
                numItems += 1; // Añadir un objeto adicional si es jefe
            }

            // Determinar el rango de nivel de objetos
            const levelRange = getLevelRange(playerLevel);

            // Obtener los objetos del archivo Excel
            fetch('items.xlsx')
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const itemsData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // Filtrar los objetos por nivel
                    const filteredItems = itemsData.filter(item => item[4] == levelRange);
                    console.log("Objetos filtrados:", filteredItems);

                    if (filteredItems.length === 0) {
                        document.getElementById('rewardResults').innerHTML = `<p>No se encontraron objetos para el nivel ${levelRange}.</p>`;
                        return;
                    }

                    // Seleccionar objetos aleatorios
                    const selectedItems = getRandomItems(filteredItems, numItems);
                    console.log("Objetos seleccionados:", selectedItems);

                    // Mostrar resultados
                    const resultsContainer = document.getElementById('rewardResults');
                    resultsContainer.innerHTML = `
                        <h3>Recompensa:</h3>
                        <p>${totalGold} de oro.</p>
                        <p>${totalExp} EXP</p>   
                        <h3>Objetos:</h3>
                        <ul>
                            ${selectedItems.map(item => `<li>${item[0]} - Nivel: ${item[4]}</li>`).join('')}
                        </ul>
                    `;
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                    document.getElementById('rewardResults').innerHTML = `<p>Error al cargar las recompensas. Verifique el archivo XLSX.</p>`;
                });
        }

        // Función para obtener el rango de nivel basado en el nivel del jugador
        function getLevelRange(playerLevel) {
            if (playerLevel < 5) {
                return 1;
            } else if (playerLevel >= 5 && playerLevel < 10) {
                return 5;         
            }else if (playerLevel >= 10 && playerLevel < 15) {
                return 10;
            } else if (playerLevel >= 15 && playerLevel < 20) {
                return 15;
            } else {
                return 20;
            }
        }

        // Función para seleccionar elementos aleatorios de una lista
        function getRandomItems(items, count) {
            const shuffled = items.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }



        function loadItems() {
            const url = 'items.xlsx'; // Cambia esto a la ruta de tu archivo

            fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const items = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    const tableBody = document.querySelector('#itemsTable tbody');
                    tableBody.innerHTML = ''; // Limpiar contenido existente

                    items.forEach((row, index) => {
                        if (index === 0) return; // Saltar la fila del encabezado

                        const tr = document.createElement('tr');
                        row.forEach((cell, cellIndex) => {
                            const td = document.createElement('td');
                            td.textContent = cell;

                            // Añadir data-label para diseño responsivo
                            switch (cellIndex) {
                                case 0: td.setAttribute('data-label', 'Nombre del objeto'); break;
                                case 1: td.setAttribute('data-label', 'Descripción'); break;
                                case 2: td.setAttribute('data-label', 'Tipo de objeto'); break;
                                case 3: td.setAttribute('data-label', 'Precio (Oro)'); break;
                                case 4: td.setAttribute('data-label', 'Nivel'); break;
                                case 5: td.setAttribute('data-label', 'Clase'); break;
                            }

                            tr.appendChild(td);
                        });

                        tr.setAttribute('data-type', row[2]); // Asume que la tercera columna es el tipo
                        tr.setAttribute('data-level', row[4]); // Asume que la quinta columna es el nivel
                        tr.setAttribute('data-class', row[5]); // Asume que la sexta columna es la clase
                        tableBody.appendChild(tr);
                    });

                    itemsLoaded = true; // Marcamos que los objetos ya se han cargado
                    filterItems(); // Aplicamos el filtro al cargar datos
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                });
        }

        function resetFilters() {
            document.getElementById('itemFilter').value = 'all';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('classFilter').value = 'all';
            filterItems();
        }

        function filterItems() {
            const typeFilter = document.getElementById('itemFilter').value;
            const levelFilter = document.getElementById('levelFilter').value;
            const classFilter = document.getElementById('classFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#itemsTable tbody tr');

            rows.forEach(row => {
                const typeMatch = typeFilter === 'all' || row.getAttribute('data-type') === typeFilter;
                const levelMatch = levelFilter === 'all' || row.getAttribute('data-level') === levelFilter;
                const classMatch = classFilter === 'all' || row.getAttribute('data-class').toLowerCase().includes(classFilter);

                if (typeMatch && levelMatch && classMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function loadExp() {
			const url = 'exp.xlsx'; // Cambia esto a la ruta de tu archivo

			fetch(url)
				.then(response => response.arrayBuffer())
				.then(data => {
					const workbook = XLSX.read(data, {type: 'array'});
					const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
					const exp = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

					const tableBody = document.querySelector('#expTable tbody');
					tableBody.innerHTML = ''; // Clear existing content

					exp.forEach((row, index) => {
						if (index === 0) return; // Skip header row

						const tr = document.createElement('tr');
						row.forEach((cell, cellIndex) => {
							const td = document.createElement('td');
							td.textContent = cell;

							// Add data-label attribute for responsive design
							switch (cellIndex) {
								case 0: td.setAttribute('data-label', 'Nivel'); break;
								case 1: td.setAttribute('data-label', 'Experiencia Total'); break;
								case 2: td.setAttribute('data-label', 'Incremento de Experiencia'); break;
							}

							tr.appendChild(td);
						});
						tableBody.appendChild(tr);
					});
				})
				.catch(error => {
					console.error('Error al cargar el archivo XLS:', error);
				});
		}

        // SKILLS LOAD AND FILTERS

        function loadSkills() {
            const url = 'skills.xlsx'; // Cambia esto a la ruta de tu archivo

            fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const skills = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    const tableBody = document.querySelector('#skillsTable tbody');
                    tableBody.innerHTML = ''; // Limpiar contenido existente

                    skills.forEach((row, index) => {
                        if (index === 0) return; // Saltar la fila del encabezado

                        const tr = document.createElement('tr');
                        row.forEach((cell, cellIndex) => {
                            const td = document.createElement('td');
                            td.textContent = cell;

                            // Add data-skill attribute for responsive design
                            switch (cellIndex) {
                                case 0: td.setAttribute('data-skill', 'Nombre de la habilidad'); break;
                                case 1: td.setAttribute('data-skill', 'Descripción'); break;
                                case 2: td.setAttribute('data-skill', 'Nivel'); break;
                                case 3: td.setAttribute('data-skill', 'Clase'); break;
                            }

                            tr.appendChild(td);
                        });

                        tr.setAttribute('data-class', row[3]); // Assume fourth column is the class
                        tableBody.appendChild(tr);
                    });

                    skillsLoaded = true; // Marcamos que las habilidades ya se han cargado
                    filterSkills(); // Aplicamos el filtro al cargar datos
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                });
        }

		function filterSkills() {
            const skillFilter = document.getElementById('skillFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#skillsTable tbody tr');

            rows.forEach(row => {
                const classMatch = skillFilter === 'all' || row.getAttribute('data-class').toLowerCase().includes(skillFilter);

                if (classMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function resetFiltersSkills() {
            document.getElementById('skillFilter').value = 'all';
            filterSkills();
        }

    </script>
</body>
</html>
