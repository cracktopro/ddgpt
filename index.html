<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Rol</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <!-- Agregar Firebase a tu proyecto -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

</head>

<body onload="openTab('load')">
    <div class="container">

        <h1>D&D - El Señor de los Anillos</h1>

        <div class="tabs">
            <div class="tab" onclick="openTab('characters')">Personajes</div>
            <div class="tab" onclick="openTab('editCharacter')">Editar</div>
            <div class="tab" onclick="openTab('enemies')">Enemigos</div>
            <div class="tab" onclick="openTab('combat')">Combate</div>
            <div class="tab" onclick="openTab('skills')">Habilidades</div>
            <div class="tab" onclick="openTab('items')">Objetos</div>
            <div class="tab" onclick="openTab('exp')">Niveles</div>
            <div class="tab" onclick="openTab('map')">Mapa</div>
            <div class="tab" onclick="openTab('load')">Datos</div>
        </div>

        <!-- PESTAÑA DE PERSONAJES -->
        <div id="characters" class="content active">
            <div class="character-actions">
                <button id="createCharacterButton" class="update-button" onclick="openCreateCharacterPopup()">Crear Personaje</button> <!-- Nuevo botón -->
                <button id="saveGameButton" onclick="saveGame()">Guardar Partida</button>
                <button id="copyToClipboardButton" onclick="copyToClipboard()">Copiar al Portapapeles</button>
            </div>
            <div id="characterContainer" class="character-container"></div>
        </div>

        <!-- Ventana Emergente para Crear Personaje -->
        <div id="createCharacterPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close" onclick="closeCreateCharacterPopup()">&times;</span>
                <h2>Crear Nuevo Personaje</h2>
                <div class="edit-container">
                    <div id="createCharacterForm">
                        <h3>Información del Personaje</h3>
                        <div class="form-group">
                            <label for="createCharacterName">Nombre:</label>
                            <input type="text" id="createCharacterName" required />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterImage">Imagen (URL):</label>
                            <input type="text" id="createCharacterImage" placeholder="URL de la imagen" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterLevel">Nivel:</label>
                            <input type="number" id="createCharacterLevel" min="1" value="1" required />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterGender">Género:</label>
                            <input type="text" id="createCharacterGender" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterRace">Raza:</label>
                            <input type="text" id="createCharacterRace" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterClass">Clase:</label>
                            <input type="text" id="createCharacterClass" />
                        </div>

                        <h3>Estadísticas</h3>
                        <div class="form-group">
                            <label for="createCharacterVIT">VIT:</label>
                            <input type="number" id="createCharacterVIT" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterFUE">FUE:</label>
                            <input type="number" id="createCharacterFUE" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterDES">DES:</label>
                            <input type="number" id="createCharacterDES" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterINT">INT:</label>
                            <input type="number" id="createCharacterINT" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterCAR">CAR:</label>
                            <input type="number" id="createCharacterCAR" min="1" value="10" />
                        </div>

                        <h3>Inventario</h3>
                        <div class="form-group">
                            <label for="createCharacterGold">Oro:</label>
                            <input type="number" id="createCharacterGold" min="0" value="0" />
                        </div>
                        <div class="form-group">
                            <label for="createCharacterItems">Objetos:</label>
                            <textarea id="createCharacterItems"></textarea>
                        </div>

                        <button class="create-button" onclick="createCharacter()">Crear</button> <!-- Botón de Crear -->
                    </div>
                </div>
            </div>
        </div>



        <div id="combat" class="content">
            <h2>Combate</h2>

            <div id="rewardPopup" class="reward-popup hidden">
                <div class="reward-popup-content">
                    <span class="close" onclick="closeRewardPopup()">&times;</span>
                    <h2>Generar Recompensas</h2>
                    <form id="rewardForm">
                        <div class="form-group">
                            <label for="playerLevel">Nivel de los Jugadores:</label>
                            <input type="number" id="playerLevel" name="playerLevel" min="1" max="20" required>
                        </div>
                        <div class="form-group">
                            <label for="enemiesDefeated">Enemigos Derrotados:</label>
                            <input type="number" id="enemiesDefeated" name="enemiesDefeated" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="isBoss">Jefe:</label>
                            <input type="checkbox" id="isBoss" name="isBoss">
                        </div>
                        <button type="button" class="generate-button" onclick="generateRewards()">Generar</button>
                    </form>
                    <div id="rewardResults" class="reward-results"></div>
                </div>
            </div>
            

            <div class="combat-container">
                <div class="combat-select">

                    <label for="characterSelect">Personaje:</label>
                    <select id="characterSelect" onchange="loadCharacterStats()">
                        <!-- Options will be populated dynamically -->
                    </select>
                    <!-- HTML LANZAR DADO -->
                    <h3>LANZAR DADO</h3>
                    <select id="diceSelect">
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                        <option value="20" selected>d20</option>
                        <option value="100">d100</option>
                    </select>
                    <button id="lanzarDado" class="buttonUpdateChar" onclick="lanzarDado()">Lanzar Dado</button>

                    <!-- Ventana Emergente para Mostrar Resultado del Dado -->
                    <div id="dicePopup" class="dice-popup hidden">
                        <div class="dice-popup-content">
                            <span class="close" onclick="closeDicePopup()">&times;</span>
                            <h2>Resultado del Dado</h2>
                            <p id="diceResultText">Aquí aparecerá el resultado.</p>
                        </div>
                    </div>
                    <!-- Botón para actualizar personajes -->
                    <p>Tras finalizar el combate, genera la recompensa y actualiza tu personaje para guardar su progreso.</p>
                    <!-- Botón para abrir la ventana de recompensas -->
                    <button id="generateRewardButton" class="buttonUpdateChar" onclick="openRewardPopup()">Generar Recompensas</button>
                    <button id="updateCharacterButton" class="buttonUpdateGreen" onclick="updateCharacterData()">Actualizar Personaje</button>
                </div>
                <div class="combat-stats" id="characterStats">
                    <!-- Character stats will be displayed here -->
                </div>
                <div class="combat-select">
                    <label for="enemySelect">Enemigo:</label>
                    <select id="enemySelect" onchange="loadEnemyStats()">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="combat-stats" id="enemyStats">
                    <!-- Enemy stats will be displayed here -->
                </div>
            </div>
            

        </div>

        <!--ENEMIGOS CRUD-->

        <!-- Pestaña de Enemigos -->
        <div id="enemies" class="content">
            <h2>Enemigos</h2>
            <!-- Botón para crear enemigo -->
            <button id="createEnemyButton" class="update-button" onclick="openCreateEnemyPopup()">Crear Enemigo</button>
            <div id="enemyContainer" class="enemy-container"></div>
            <!-- Formulario de eliminación de enemigos -->
            <div class="enemy-actions">
                <h3>Eliminar Enemigo</h3>
                <div class="form-group">
                    <label for="deleteEnemySelect">Seleccionar Enemigo:</label>
                    <select id="deleteEnemySelect">
                        <!-- Las opciones se llenarán dinámicamente -->
                    </select>
                    <button class="delete-button" onclick="deleteEnemy()">Borrar</button>
                </div>
            </div>
        </div>

        <!-- Ventana Emergente para Crear Enemigo -->
        <div id="createEnemyPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close" onclick="closeCreateEnemyPopup()">&times;</span>
                <h2>Crear Nuevo Enemigo</h2>
                <div class="edit-container">
                    <div id="createEnemyForm">
                        <h3>Información del Enemigo</h3>
                        <div class="form-group">
                            <label for="createEnemyName">Nombre:</label>
                            <input type="text" id="createEnemyName" required />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyLevel">Nivel:</label>
                            <input type="number" id="createEnemyLevel" min="1" value="1" required />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyClass">Clase:</label>
                            <input type="text" id="createEnemyClass" />
                        </div>

                        <h3>Estadísticas</h3>
                        <div class="form-group">
                            <label for="createEnemyVIT">VIT:</label>
                            <input type="number" id="createEnemyVIT" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyFUE">FUE:</label>
                            <input type="number" id="createEnemyFUE" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyDES">DES:</label>
                            <input type="number" id="createEnemyDES" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyINT">INT:</label>
                            <input type="number" id="createEnemyINT" min="1" value="10" />
                        </div>
                        <div class="form-group">
                            <label for="createEnemyCAR">CAR:</label>
                            <input type="number" id="createEnemyCAR" min="1" value="10" />
                        </div>

                        <button class="update-button" onclick="createEnemy()">Crear</button> <!-- Botón de Crear Enemigo -->
                    </div>
                </div>
            </div>
        </div>

        <div id="load" class="content">
            <input type="file" id="fileInput" accept=".json" onchange="loadFile()" />
            <p>Selecciona el fichero JSON o pégalo directamente.</p>
            <textarea id="jsonInput" placeholder="Pega aquí el JSON..."></textarea>
            <button onclick="loadData()">Cargar Datos</button>
        </div>

        <!-- EDITAR PERSONAJES -->
        <div id="editCharacter" class="content">
            <h2>Editar Personaje</h2>
            <div class="edit-container">
                <!-- Select para elegir el personaje -->
                <label for="editCharacterSelect">Seleccionar Personaje:</label>
                <select id="editCharacterSelect" onchange="loadCharacterForEditing()">
                    <!-- Las opciones se llenarán dinámicamente -->
                </select>

                <!-- Formulario de edición del personaje -->
                <div id="editCharacterForm">
                    <h3>Información del Personaje</h3>
                    <div class="form-group">
                        <label for="editCharacterName">Nombre:</label>
                        <input type="text" id="editCharacterName" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterImage">Imagen (URL):</label>
                        <input type="text" id="editCharacterImage" placeholder="URL de la imagen" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterLevel">Nivel:</label>
                        <input type="number" id="editCharacterLevel" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterGender">Género:</label>
                        <input type="text" id="editCharacterGender" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterRace">Raza:</label>
                        <input type="text" id="editCharacterRace" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterClass">Clase:</label>
                        <input type="text" id="editCharacterClass" />
                    </div>

                    <h3>Estadísticas</h3>
                    <div class="form-group">
                        <label for="editCharacterVIT">VIT:</label>
                        <input type="number" id="editCharacterVIT" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterFUE">FUE:</label>
                        <input type="number" id="editCharacterFUE" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterDES">DES:</label>
                        <input type="number" id="editCharacterDES" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterINT">INT:</label>
                        <input type="number" id="editCharacterINT" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterCAR">CAR:</label>
                        <input type="number" id="editCharacterCAR" />
                    </div>

                    <h3>Inventario</h3>
                    <div class="form-group">
                        <label for="editCharacterGold">Oro:</label>
                        <input type="number" id="editCharacterGold" />
                    </div>
                    <div class="form-group">
                        <label for="editCharacterItems">Objetos:</label>
                        <textarea id="editCharacterItems"></textarea>
                    </div>

                    <h3>Experiencia</h3>
                    <div class="form-group">
                        <label for="editCharacterXP">XP:</label>
                        <input type="number" id="editCharacterXP" />
                    </div>

                    <button class="save-button" onclick="saveCharacterChanges()">Guardar Cambios</button>
                    <button class="delete-button" onclick="deleteCharacter()">Borrar Personaje</button>
                </div>
            </div>
        </div>

        

        <!--SKILLS -->
        <div id="skills" class="content">
            <!--FILTERS-->
            <div class="filters">
				<select id="skillFilter" onchange="filterSkills()">
					<option value="all">-Clase-</option>
                    <option value="Guerrero">Guerrero</option>
                    <option value="Explorador">Explorador</option>
                    <option value="Pícaro">Pícaro</option>
                    <option value="Hechicero">Hechicero</option>
                    <option value="Paladín">Paladín</option>
                    <option value="Druida">Druida</option>
                    <option value="Clérigo">Clérigo</option>
                    <option value="Bardo">Bardo</option>
				</select>
                <select id="levelSkillFilter" onchange="filterSkills()">
                    <option value="all">-Nivel-</option>
                    <option value="1">Nivel 1</option>
                    <option value="2">Nivel 2</option>
                    <option value="3">Nivel 3</option>
                    <option value="4">Nivel 4</option>
                    <option value="5">Nivel 5</option>
                    <option value="6">Nivel 6</option>
                    <option value="7">Nivel 7</option>
                    <option value="8">Nivel 8</option>
                    <option value="9">Nivel 9</option>
                    <option value="10">Nivel 10</option>
                </select>
                <button class="reset-button" onclick="resetFiltersSkills()">Restablecer Filtros</button>
            </div>

            <!--TABLE-->
            <table id="skillsTable">
                <thead>
                    <tr>
                        <th>Nombre de la habilidad</th>
                        <th>Descripción</th>
                        <th>Nivel</th>
                        <th>Clase</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!--FIN SKILLS-->

        <!--ITEMS-->
        <div id="items" class="content">
			<div class="filters">
				<select id="itemFilter" onchange="filterItems()">
					<option value="all">-Tipo de objeto-</option>
					<option value="Poción">Poción</option>
					<option value="Arma">Arma</option>
					<option value="Armadura">Armadura</option>

                    <option value="Cabeza">Cabeza</option>
                    <option value="Brazales">Brazales</option>
                    <option value="Guantes">Guantes</option>
                    <option value="Cinturón">Cinturón</option>
                    <option value="Botas">Botas</option>

					<option value="Para vender">Para vender</option>
				</select>
				<select id="levelFilter" onchange="filterItems()">
					<option value="all">-Nivel-</option>
					<option value="1">Nivel 1</option>
					<option value="10">Nivel 10</option>
					<option value="15">Nivel 15</option>
					<option value="20">Nivel 20</option>
					<!-- Añadir más niveles según sea necesario -->
				</select>
				<select id="classFilter" onchange="filterItems()">
					<option value="all">-Clase-</option>
					<option value="Todos">Todos</option>
					<option value="Guerrero">Guerrero</option>
					<option value="Explorador">Explorador</option>
					<option value="Hechicero">Hechicero</option>
					<option value="Pícaro">Pícaro</option>
					<option value="Paladín">Paladín</option>
					<option value="Bardo">Bardo</option>
					<option value="Clérigo">Clérigo</option>
					<option value="Druida">Druida</option>
					<!-- Añadir más clases según sea necesario -->
				</select>
				<button class="reset-button" onclick="resetFilters()">Restablecer Filtros</button>
			</div>
			
            <table id="itemsTable">
				<thead>
					<tr>
						<th>Nombre del objeto</th>
						<th>Descripción</th>
						<th>Tipo de objeto</th>
						<th>Precio (Oro)</th>
						<th>Nivel</th>
						<th>Clase</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
        </div>
        <!--FIN ITEMS-->

        <!--NIVELES -->
        <div id="exp" class="content">
            <!--TABLE-->
            <table id="expTable">
                <thead>
                    <tr>
                        <th>Nivel</th>
                        <th>Experiencia Total</th>
                        <th>Incremento de Experiencia</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!--FIN NIVELES-->

        <!--MAP-->

        <div id="map" class="content">
            <h2>Mapa de la Tierra Media</h2>
            <div id="mapContainer" class="map-container">
                <p>Haz click sobre el mapa para insertar una marca.</p>
                <button onclick="clearMarkers()" class="reset-button">Borrar Marcas</button>
                <img src="https://tierramedia.net/wp-content/uploads/mapa-tierra-media-16.jpg" id="mapImage" alt="Mapa de la Tierra Media">
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase para tu aplicación web
        const firebaseConfig = {
            apiKey: "AIzaSyDEbeTLOwJUoRGbdSSpkPnFmTgBddGzyH8",
            authDomain: "ddgpt-c99bf.firebaseapp.com",
            projectId: "ddgpt-c99bf",
            storageBucket: "ddgpt-c99bf.appspot.com",
            messagingSenderId: "358764808774",
            appId: "1:358764808774:web:a2c51689413be5ee519847",
            measurementId: "G-GFT6CYX217"
        };

        // Inicializa Firebase
        const app = firebase.initializeApp(firebaseConfig);

        // Inicializa Firestore
        const db = firebase.firestore();

        // Función para inicializar la aplicación
        function initializeApp() {
            loadExpData(); // Cargar datos de experiencia desde un archivo XLSX
            loadSavedGame(); // Cargar la partida guardada desde Firestore
            openTab('characters'); // Abre la pestaña de personajes por defecto
            populateEditCharacterSelect(); // Poblar el select de personajes al inicio
            loadEnemyData(); // Cargar datos de enemigos
        }

        let charactersData = [];
        let enemiesData = [];
        let skillsLoaded = false; // Variable para controlar la carga de habilidades
        let itemsLoaded = false; // Variable para controlar si los datos de los objetos ya se han cargado

        function openTab(tabName) {
            // Remover la clase 'active' de todos los contenidos
            const contents = document.getElementsByClassName("content");
            for (let i = 0; i < contents.length; i++) {
                contents[i].classList.remove("active");
            }

            // Mostrar el contenido correspondiente
            document.getElementById(tabName).classList.add("active");

            // Remover la clase 'active' de todas las pestañas
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }

            // Buscar la pestaña activa y añadir la clase 'active'
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].getAttribute('onclick').includes(tabName)) {
                    tabs[i].classList.add("active");
                }
            }

            // Cargar datos específicos según la pestaña
            if (tabName === 'items') {
                if (!itemsLoaded) {
                    loadItems();
                } else {
                    filterItems(); // Aplicamos el filtro actual al volver a la pestaña
                }
            }
            if (tabName === 'skills') {
                if (!skillsLoaded) { // Verificamos si ya hemos cargado las habilidades
                    loadSkills();
                } else {
                    filterSkills(); // Aplicamos el filtro actual al volver a la pestaña
                }
            }
            if (tabName === 'exp') {
                loadExp();
            }
        }

        document.getElementById('mapImage').addEventListener('click', function(event) {
            var mapContainer = document.getElementById('mapContainer');
            var rect = mapContainer.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;

            var marker = document.createElement('div');
            marker.classList.add('marker');
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            mapContainer.appendChild(marker);
        });

        function clearMarkers() {
            var mapContainer = document.getElementById('mapContainer');
            var markers = document.getElementsByClassName('marker');
            while (markers.length > 0) {
                markers[0].parentNode.removeChild(markers[0]);
            }
        }
        
        // Función para guardar la partida como un archivo JSON y descargarlo
        function saveGame() {
            // Convertir los datos de los personajes y enemigos a JSON
            const jsonData = JSON.stringify({
                characters: charactersData,
                enemies: enemiesData
            }, null, 2);

            // Guardar los datos en Firestore
            db.collection('games').doc('currentGame').set({
                characters: charactersData,
                enemies: enemiesData
            })
            .then(() => {
                console.log('Partida guardada exitosamente en Firebase.');
                alert('Partida guardada exitosamente en Firebase.');

                // Descargar el archivo JSON
                const formattedDate = getFormattedDate();
                downloadJSONFile(jsonData, `savegame_${formattedDate}.json`);
            })
            .catch((error) => {
                console.error('Error al guardar la partida en Firebase:', error);
                alert('Error al guardar la partida en Firebase.');
            });
        }

        // Función para obtener la fecha formateada
        function getFormattedDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Añadir cero inicial si es necesario
            const day = String(now.getDate()).padStart(2, '0');        // Añadir cero inicial si es necesario
            const hours = String(now.getHours()).padStart(2, '0');     // Añadir cero inicial si es necesario
            const minutes = String(now.getMinutes()).padStart(2, '0'); // Añadir cero inicial si es necesario
            const seconds = String(now.getSeconds()).padStart(2, '0'); // Añadir cero inicial si es necesario
            return `${day}-${month}-${year}_${hours}-${minutes}-${seconds}`;
        }

        // Función para descargar un archivo JSON
        function downloadJSONFile(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }


        function deleteCharacter() {
            const selectedName = document.getElementById('editCharacterSelect').value;
            const characterIndex = charactersData.findIndex(c => c.name === selectedName);

            if (characterIndex !== -1) {
                // Confirmación antes de eliminar
                const confirmDelete = confirm('¿Estás seguro de que deseas borrar el personaje: ' + selectedName + '?');
                
                if (confirmDelete) {
                    // Eliminar el personaje del array
                    charactersData.splice(characterIndex, 1);

                    // Actualizar las vistas
                    loadCharacterData(); // Actualiza la pestaña de Personajes
                    populateCombatSelects(); // Actualiza la pestaña de Combate
                    populateEditCharacterSelect(); // Actualiza el select en la pestaña de Editar Personajes

                    alert('Personaje ' + selectedName + ' borrado exitosamente.');
                }
            } else {
                console.error('Error al borrar: personaje no encontrado.');
            }
        }

        // Función para copiar los datos de los personajes al portapapeles
        function copyToClipboard() {
            const jsonData = JSON.stringify({ 
                characters: charactersData,
                enemies: enemiesData // Agregar enemigos al JSON
            }, null, 2);

            // Utilizar la API del portapapeles
            navigator.clipboard.writeText(jsonData).then(() => {
                alert('Datos copiados al portapapeles');
            }).catch(err => {
                console.error('Error al copiar al portapapeles:', err);
                alert('Error al copiar al portapapeles');
            });
        }

        // Función para lanzar el dado
        function lanzarDado() {
            // Obtener el valor del dado seleccionado
            const diceSelect = document.getElementById('diceSelect');
            const diceSides = parseInt(diceSelect.value);

            // Generar un número aleatorio entre 1 y el número de caras del dado
            const result = Math.floor(Math.random() * diceSides) + 1;

            // Mostrar el resultado en la ventana emergente
            showDiceResult(result, diceSides);
        }

        // Función para mostrar el resultado del dado
        function showDiceResult(result, diceSides) {
            const diceResultText = document.getElementById('diceResultText');

            // Formatear el mensaje de resultado
            diceResultText.innerHTML = `<strong>${result}</strong>`;

            // Mostrar la ventana emergente
            const dicePopup = document.getElementById('dicePopup');
            dicePopup.style.display = 'flex';
        }

        // Función para cerrar la ventana emergente del dado
        function closeDicePopup() {
            const dicePopup = document.getElementById('dicePopup');
            dicePopup.style.display = 'none';
        }

        // Función para cargar los datos de savegame.json al cargar la página
        function loadSavedGame() {
            db.collection('games').doc('currentGame').get()
            .then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.characters) {
                        charactersData = data.characters;
                        enemiesData = data.enemies || []; // Manejar enemigos si existen
                        loadCharacterData();
                        loadEnemyData();
                        populateCombatSelects();
                        populateEditCharacterSelect();
                        openTab('characters');
                    }
                } else {
                    console.error('No se encontró ninguna partida guardada en Firebase.');
                    alert('No se encontró ninguna partida guardada.');
                }
            })
            .catch((error) => {
                console.error('Error al cargar la partida desde Firebase:', error);
                alert('Error al cargar la partida desde Firebase.');
            });
        }


        // Cargar datos del JSON

        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    document.getElementById('jsonInput').value = content;
                };
                reader.readAsText(file);
            } else {
                alert("Por favor, selecciona un archivo.");
            }
        }

        //ENEMIGOS CRUD

        // Función para abrir la ventana de creación de enemigos
        function openCreateEnemyPopup() {
            const popup = document.getElementById('createEnemyPopup');
            popup.classList.remove('hidden');
            popup.style.display = 'flex'; // Mostrar como flex para centrar
        }

        // Función para cerrar la ventana de creación de enemigos
        function closeCreateEnemyPopup() {
            const popup = document.getElementById('createEnemyPopup');
            popup.classList.add('hidden');
            popup.style.display = 'none'; // Ocultar ventana emergente
        }

        // Función para crear un nuevo enemigo
        function createEnemy() {
            const name = document.getElementById('createEnemyName').value.trim();
            const level = parseInt(document.getElementById('createEnemyLevel').value);
            const classType = document.getElementById('createEnemyClass').value.trim();
            const vit = parseInt(document.getElementById('createEnemyVIT').value);
            const fue = parseInt(document.getElementById('createEnemyFUE').value);
            const des = parseInt(document.getElementById('createEnemyDES').value);
            const intStat = parseInt(document.getElementById('createEnemyINT').value);
            const car = parseInt(document.getElementById('createEnemyCAR').value);

            if (!name || isNaN(level)) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }

            // Crear un nuevo objeto de enemigo
            const newEnemy = {
                name: name,
                level: level,
                class: classType,
                stats: {
                    VIT: vit,
                    FUE: fue,
                    DES: des,
                    INT: intStat,
                    CAR: car
                }
            };

            // Agregar el nuevo enemigo a la lista de enemigos
            enemiesData.push(newEnemy);

            // Actualizar las vistas
            loadEnemyData(); // Actualiza la pestaña de Enemigos
            populateCombatSelects(); // Actualiza la pestaña de Combate

            // Cerrar la ventana emergente y restablecer el formulario
            closeCreateEnemyPopup();
        }

        // Función para cargar los enemigos en el select de eliminación
        function populateDeleteEnemySelect() {
            const deleteEnemySelect = document.getElementById('deleteEnemySelect');
            deleteEnemySelect.innerHTML = enemiesData.map(enemy => `<option value="${enemy.name}">${enemy.name}</option>`).join('');

            // Seleccionar el primer enemigo si existe
            if (enemiesData.length > 0) {
                deleteEnemySelect.value = enemiesData[0].name;
            }
        }

        // Función para eliminar un enemigo
        function deleteEnemy() {
            const selectedName = document.getElementById('deleteEnemySelect').value;
            const enemyIndex = enemiesData.findIndex(e => e.name === selectedName);

            if (enemyIndex !== -1) {
                // Confirmación antes de eliminar
                const confirmDelete = confirm('¿Estás seguro de que deseas borrar el enemigo: ' + selectedName + '?');

                if (confirmDelete) {
                    // Eliminar el enemigo del array
                    enemiesData.splice(enemyIndex, 1);

                    // Actualizar las vistas
                    loadEnemyData(); // Actualiza la pestaña de Enemigos
                    populateCombatSelects(); // Actualiza la pestaña de Combate

                }
            } else {
                console.error('Error al borrar: enemigo no encontrado.');
            }
        }

        // Función para cargar los datos de enemigos y actualizar la vista
        function loadEnemyData() {
            const enemyContainer = document.getElementById('enemyContainer');
            enemyContainer.innerHTML = ''; // Limpiar contenido existente

            enemiesData.forEach(enemy => {
                const enemyDiv = document.createElement('div');
                enemyDiv.className = 'enemy';

                const enemyInfo = `
                    <h2>${enemy.name}</h2>
                    <h3>Nivel: ${enemy.level}</h3>
                    <p><strong>Clase:</strong> ${enemy.class}</p>
                    <h3>Estadísticas</h3>
                    <ul class="stats">
                        <li><strong>VIT:</strong> ${enemy.stats.VIT}</li>
                        <li><strong>FUE:</strong> ${enemy.stats.FUE}</li>
                        <li><strong>DES:</strong> ${enemy.stats.DES}</li>
                        <li><strong>INT:</strong> ${enemy.stats.INT}</li>
                        <li><strong>CAR:</strong> ${enemy.stats.CAR}</li>
                    </ul>
                `;

                enemyDiv.innerHTML = enemyInfo;
                enemyContainer.appendChild(enemyDiv);
            });

            // Llenar el select para eliminar enemigos
            populateDeleteEnemySelect();
        }

        // Función para cargar los datos del JSON
        function loadData() {
            const jsonInput = document.getElementById('jsonInput').value;
            const characterContainer = document.getElementById('characterContainer');
            const enemyContainer = document.getElementById('enemyContainer');
            characterContainer.innerHTML = ''; // Limpiar contenido existente
            enemyContainer.innerHTML = ''; // Limpiar contenido existente

            try {
                const data = JSON.parse(jsonInput);

                // Verificar que los datos de personajes existan
                if (!data.characters || !Array.isArray(data.characters)) {
                    throw new Error('No se encontraron datos de personajes o el formato es incorrecto.');
                }

                // Guardar datos de personajes para uso posterior
                charactersData = data.characters;
                console.log("Datos de personajes cargados:", charactersData);

                // Poblar el contenedor de personajes
                charactersData.forEach(character => {
                    const characterDiv = document.createElement('div');
                    characterDiv.className = 'character';

                    // Construir la lista de objetos
                    const itemsList = character.inventory.items.map(item => `<li>${item}</li>`).join('');

                    const characterInfo = `
                        <img src="${character.image}" alt="${character.name}">
                        <h2>${character.name}</h2>
                        <h3>Nivel: ${character.level}</h3>
                        <p><strong>Género:</strong> ${character.gender}</p>
                        <p><strong>Raza:</strong> ${character.race}</p>
                        <p><strong>Clase:</strong> ${character.class}</p>
                        <h3>Estadísticas</h3>
                        <ul class="stats">
                            <li><strong>VIT:</strong> ${character.stats.VIT}</li>
                            <li><strong>FUE:</strong> ${character.stats.FUE}</li>
                            <li><strong>DES:</strong> ${character.stats.DES}</li>
                            <li><strong>INT:</strong> ${character.stats.INT}</li>
                            <li><strong>CAR:</strong> ${character.stats.CAR}</li>
                        </ul>
                        <h3>Inventario</h3>
                        <ul class="inventory">
                            <li><strong>Oro:</strong> ${character.inventory.gold}</li>
                            <li><strong>Objetos:</strong><ul>${itemsList}</ul></li>
                        </ul>
                        <h3>Experiencia</h3>
                        <p>${character.xp}</p>
                    `;

                    characterDiv.innerHTML = characterInfo;
                    characterContainer.appendChild(characterDiv);
                });

                // Verificar si existen datos de enemigos y manejarlos
                if (data.enemies && Array.isArray(data.enemies)) {
                    // Guardar datos de enemigos para uso posterior
                    enemiesData = data.enemies;
                    console.log("Datos de enemigos cargados:", enemiesData);

                    // Poblar el contenedor de enemigos
                    enemiesData.forEach(enemy => {
                        const enemyDiv = document.createElement('div');
                        enemyDiv.className = 'enemy';

                        const enemyInfo = `
                            <h2>${enemy.name}</h2>
                            <h3>Nivel: ${enemy.level}</h3>
                            <p><strong>Clase:</strong> ${enemy.class}</p>
                            <h3>Estadísticas</h3>
                            <ul class="stats">
                                <li><strong>VIT:</strong> ${enemy.stats.VIT}</li>
                                <li><strong>FUE:</strong> ${enemy.stats.FUE}</li>
                                <li><strong>DES:</strong> ${enemy.stats.DES}</li>
                                <li><strong>INT:</strong> ${enemy.stats.INT}</li>
                                <li><strong>CAR:</strong> ${enemy.stats.CAR}</li>
                            </ul>
                        `;

                        enemyDiv.innerHTML = enemyInfo;
                        enemyContainer.appendChild(enemyDiv);
                        populateDeleteEnemySelect();
                    });
                } else {
                    console.warn('No se encontraron datos de enemigos o el formato es incorrecto.');
                    enemiesData = []; // Inicializar con una lista vacía si no hay enemigos
                }

                // Poblar los selects en la pestaña de combate
                populateCombatSelects();

                openTab('characters'); // Cambia a la pestaña de personajes como predeterminada
                populateEditCharacterSelect();
            } catch (error) {
                console.error('Error al cargar el JSON:', error);
                alert('JSON inválido. Por favor, verifica el formato e inténtalo nuevamente.');
            }
        }

        //CREAR PERSONAJES:

        function openCreateCharacterPopup() {
            const popup = document.getElementById('createCharacterPopup');
            popup.classList.remove('hidden');
            popup.style.display = 'block'; // Asegúrate de que el display se cambie a block
        }

        function closeCreateCharacterPopup() {
            const popup = document.getElementById('createCharacterPopup');
            popup.classList.add('hidden');
            popup.style.display = 'none'; // Cambia display a none al cerrar
        }

        // Función para crear un nuevo personaje
        function createCharacter() {
            const name = document.getElementById('createCharacterName').value.trim();
            const image = document.getElementById('createCharacterImage').value.trim();
            const level = parseInt(document.getElementById('createCharacterLevel').value);
            const gender = document.getElementById('createCharacterGender').value.trim();
            const race = document.getElementById('createCharacterRace').value.trim();
            const classType = document.getElementById('createCharacterClass').value.trim();
            const vit = parseInt(document.getElementById('createCharacterVIT').value);
            const fue = parseInt(document.getElementById('createCharacterFUE').value);
            const des = parseInt(document.getElementById('createCharacterDES').value);
            const intStat = parseInt(document.getElementById('createCharacterINT').value);
            const car = parseInt(document.getElementById('createCharacterCAR').value);
            const gold = parseInt(document.getElementById('createCharacterGold').value);
            const items = document.getElementById('createCharacterItems').value.split(',').map(item => item.trim());

            if (!name || !level) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }

            // Calcular experiencia según el nivel
            const xp = getExpForLevel(level);
            if (xp === null) {
                alert('Nivel no válido. Por favor, ingresa un nivel válido.');
                return;
            }

            // Crear un nuevo objeto de personaje
            const newCharacter = {
                name: name,
                image: image,
                level: level,
                gender: gender,
                race: race,
                class: classType,
                stats: {
                    VIT: vit,
                    FUE: fue,
                    DES: des,
                    INT: intStat,
                    CAR: car
                },
                inventory: {
                    gold: gold,
                    items: items
                },
                xp: xp // Establecer la experiencia calculada
            };

            // Agregar el nuevo personaje a la lista de personajes
            charactersData.push(newCharacter);

            // Actualizar las vistas
            loadCharacterData(); // Actualiza la pestaña de Personajes
            populateCombatSelects(); // Actualiza la pestaña de Combate
            populateEditCharacterSelect(); // Actualiza el select en la pestaña de Editar Personajes

            // Cerrar la ventana emergente y restablecer el formulario
            closeCreateCharacterPopup();

            alert('Personaje creado exitosamente: ' + name);
        }



        //EDITAR INFO DE LOS PERSONAJES:

        // Función para cargar los personajes en el select de edición
        function populateEditCharacterSelect() {
            const editCharacterSelect = document.getElementById('editCharacterSelect');
            editCharacterSelect.innerHTML = charactersData.map(character => `<option value="${character.name}">${character.name}</option>`).join('');

            if (charactersData.length > 0) {
                editCharacterSelect.value = charactersData[0].name;
                loadCharacterForEditing(); // Cargar el primer personaje por defecto
            }
        }

        // Función para cargar los datos del personaje seleccionado en el formulario de edición
        // Función para cargar los datos del personaje seleccionado en el formulario de edición
        function loadCharacterForEditing() {
            const selectedName = document.getElementById('editCharacterSelect').value;
            const character = charactersData.find(c => c.name === selectedName);

            if (character) {
                document.getElementById('editCharacterName').value = character.name;
                document.getElementById('editCharacterImage').value = character.image; // Cargar URL de la imagen
                document.getElementById('editCharacterLevel').value = character.level;
                document.getElementById('editCharacterGender').value = character.gender;
                document.getElementById('editCharacterRace').value = character.race;
                document.getElementById('editCharacterClass').value = character.class;
                document.getElementById('editCharacterVIT').value = character.stats.VIT;
                document.getElementById('editCharacterFUE').value = character.stats.FUE;
                document.getElementById('editCharacterDES').value = character.stats.DES;
                document.getElementById('editCharacterINT').value = character.stats.INT;
                document.getElementById('editCharacterCAR').value = character.stats.CAR;
                document.getElementById('editCharacterGold').value = character.inventory.gold;
                document.getElementById('editCharacterItems').value = character.inventory.items.join(', ');
                document.getElementById('editCharacterXP').value = character.xp;
            } else {
                console.warn('Personaje no encontrado para editar:', selectedName);
            }
        }

        function saveCharacterChanges() {
            const selectedName = document.getElementById('editCharacterSelect').value;
            const character = charactersData.find(c => c.name === selectedName);

            if (character) {
                // Obtener el nivel antes de los cambios
                const previousLevel = character.level;

                // Actualizar los datos del personaje
                const newName = document.getElementById('editCharacterName').value;
                character.name = newName;
                character.image = document.getElementById('editCharacterImage').value; // Actualizar la URL de la imagen

                // Obtener el nivel introducido manualmente
                const newLevel = parseInt(document.getElementById('editCharacterLevel').value);

                character.gender = document.getElementById('editCharacterGender').value;
                character.race = document.getElementById('editCharacterRace').value;
                character.class = document.getElementById('editCharacterClass').value;
                character.stats.VIT = parseInt(document.getElementById('editCharacterVIT').value);
                character.stats.FUE = parseInt(document.getElementById('editCharacterFUE').value);
                character.stats.DES = parseInt(document.getElementById('editCharacterDES').value);
                character.stats.INT = parseInt(document.getElementById('editCharacterINT').value);
                character.stats.CAR = parseInt(document.getElementById('editCharacterCAR').value);
                character.inventory.gold = parseInt(document.getElementById('editCharacterGold').value);

                // Actualizar los objetos del inventario y formatearlos como lista
                character.inventory.items = document.getElementById('editCharacterItems').value.split(',').map(item => item.trim());

                // Obtener el nuevo nivel especificado
                if (newLevel !== previousLevel) {
                    // Si el nivel ha cambiado manualmente, actualizar la experiencia según la tabla
                    const expForNewLevel = getExpForLevel(newLevel);
                    if (expForNewLevel !== null) {
                        character.xp = expForNewLevel; // Ajustar experiencia al nivel especificado
                    } else {
                        alert('Nivel especificado no válido. No hay datos de experiencia para este nivel.');
                    }
                } else {
                    // Si el nivel no ha cambiado manualmente, mantener o recalcular según la XP
                    character.xp = parseInt(document.getElementById('editCharacterXP').value);
                }

                // Calcular y actualizar el nuevo nivel basado en la experiencia total
                const calculatedLevel = calculateLevel(character.xp);
                character.level = calculatedLevel; // Asegurarse de que el nivel refleje la experiencia

                // Refrescar la vista de personajes y combate sin cambiar la selección actual
                updateCharacterDisplay(character);
                populateCombatSelects();

                alert('Cambios guardados exitosamente para el personaje: ' + character.name + ' a nivel ' + character.level);
            } else {
                console.error('Error al guardar los cambios: personaje no encontrado.');
            }
        }

        // Función para actualizar la visualización del personaje
        function updateCharacterDisplay(updatedCharacter) {
            // Actualizar el personaje específico en la interfaz
            const characterDivs = document.querySelectorAll('#characterContainer .character');
            characterDivs.forEach(characterDiv => {
                const characterName = characterDiv.querySelector('h2').innerText;
                if (characterName === updatedCharacter.name) {
                    characterDiv.querySelector('h3').innerText = `Nivel: ${updatedCharacter.level}`;
                    characterDiv.querySelector('img').src = updatedCharacter.image;
                    
                    // Encontrar y actualizar el género
                    const genderElement = characterDiv.querySelector('p:nth-of-type(1) strong');
                    if (genderElement) {
                        genderElement.innerText = updatedCharacter.gender;
                    }

                    // Encontrar y actualizar la raza
                    const raceElement = characterDiv.querySelector('p:nth-of-type(2) strong');
                    if (raceElement) {
                        raceElement.innerText = updatedCharacter.race;
                    }

                    // Encontrar y actualizar la clase
                    const classElement = characterDiv.querySelector('p:nth-of-type(3) strong');
                    if (classElement) {
                        classElement.innerText = updatedCharacter.class;
                    }

                    // Actualizar estadísticas
                    const statsList = characterDiv.querySelector('.stats');
                    statsList.children[0].innerText = `VIT: ${updatedCharacter.stats.VIT}`;
                    statsList.children[1].innerText = `FUE: ${updatedCharacter.stats.FUE}`;
                    statsList.children[2].innerText = `DES: ${updatedCharacter.stats.DES}`;
                    statsList.children[3].innerText = `INT: ${updatedCharacter.stats.INT}`;
                    statsList.children[4].innerText = `CAR: ${updatedCharacter.stats.CAR}`;

                    // Actualizar inventario
                    const inventoryList = characterDiv.querySelector('.inventory');
                    inventoryList.children[0].innerText = `Oro: ${updatedCharacter.inventory.gold}`;
                    inventoryList.children[1].innerHTML = `Objetos:<ul>${updatedCharacter.inventory.items.map(item => `<li>${item}</li>`).join('')}</ul>`;

                    // Actualizar experiencia
                    const xpElement = characterDiv.querySelector('p:nth-of-type(4)');
                    if (xpElement) {
                        xpElement.innerText = updatedCharacter.xp;
                    }
                }
            });

            // Mantener la selección actual en el formulario de edición
            const editCharacterSelect = document.getElementById('editCharacterSelect');
            editCharacterSelect.value = updatedCharacter.name;
        }

        // Función para obtener la experiencia total requerida para un nivel dado
        function getExpForLevel(level) {
            const levelData = expData.find(data => data.level === level);
            return levelData ? levelData.totalExp : null; // Devuelve null si el nivel no está definido
        }


        // Poblar los selects de personajes y enemigos en la pestaña de combate
        function populateCombatSelects() {
            const characterSelect = document.getElementById('characterSelect');
            const enemySelect = document.getElementById('enemySelect');

            characterSelect.innerHTML = charactersData.map(character => `<option value="${character.name}">${character.name}</option>`).join('');
            enemySelect.innerHTML = enemiesData.map(enemy => `<option value="${enemy.name}">${enemy.name}</option>`).join('');

            // Si hay personajes, carga el primero
            if (charactersData.length > 0) {
                characterSelect.value = charactersData[0].name;
                loadCharacterStats();
            }

            // Si hay enemigos, carga el primero
            if (enemiesData.length > 0) {
                enemySelect.value = enemiesData[0].name;
                loadEnemyStats();
            }
        }

        //CALCULAR NIVEL EN FUNCIÓN DE LA TABLA EXP.XLSX

        let expData = []; // Array para almacenar los datos de experiencia

        function loadExpData() {
            const url = 'exp.xlsx'; // Ruta del archivo Excel

            fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const expArray = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    console.log('Datos de Excel:', expArray); // Verificar la carga

                    // Convertir a un array de objetos para un acceso fácil
                    expData = expArray.slice(1).map(row => ({
                        level: row[0],
                        totalExp: row[1]
                    }));

                    console.log('Datos de experiencia cargados:', expData); // Verificar carga en expData
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                });
        }


        function updateCharacterData() {
            // Obtener el personaje seleccionado
            const characterName = document.getElementById('characterSelect').value;
            const character = charactersData.find(c => c.name === characterName);

            if (!character) {
                alert('Por favor, selecciona un personaje para actualizar.');
                return;
            }

            // Obtener las recompensas generadas
            const rewardResults = document.getElementById('rewardResults');

            // Variables para almacenar experiencia, oro y objetos de recompensas
            let expGain = 0;
            let goldGain = 0;
            let items = [];

            // Solo procesar recompensas si existen
            if (rewardResults.innerHTML) {
                // Extraer experiencia, oro y objetos de las recompensas
                const expRegex = /(\d+) EXP/;
                const goldRegex = /(\d+) de oro/;
                const itemsRegex = /<li>(.*?) - Nivel:/g;

                const expMatch = expRegex.exec(rewardResults.innerHTML);
                const goldMatch = goldRegex.exec(rewardResults.innerHTML);
                let itemsMatch;

                while ((itemsMatch = itemsRegex.exec(rewardResults.innerHTML)) !== null) {
                    items.push(itemsMatch[1]);
                }

                expGain = expMatch ? parseInt(expMatch[1], 10) : 0;
                goldGain = goldMatch ? parseInt(goldMatch[1], 10) : 0;
            }

            // Actualizar la experiencia del personaje
            character.xp += expGain;
            character.inventory.gold += goldGain;
            character.inventory.items = [...character.inventory.items, ...items];

            // Calcular el nuevo nivel basado en la experiencia total
            console.log('Datos de experiencia:', expData);
            const newLevel = calculateLevel(character.xp);
            character.level = newLevel; // Actualizar el nivel del personaje
            console.log(`Nivel calculado para ${character.name}:`, newLevel);

            // Actualizar otros datos del personaje
            const characterStats = document.getElementById('characterStats');
            character.stats.VIT = parseInt(document.getElementById('character-VIT').value) || character.stats.VIT;
            character.stats.FUE = parseInt(document.getElementById('character-FUE').value) || character.stats.FUE;
            character.stats.DES = parseInt(document.getElementById('character-DES').value) || character.stats.DES;
            character.stats.INT = parseInt(document.getElementById('character-INT').value) || character.stats.INT;
            character.stats.CAR = parseInt(document.getElementById('character-CAR').value) || character.stats.CAR;

            // Refrescar la vista de personajes
            loadCharacterData();
            populateEditCharacterSelect(); // Asegurarse de actualizar los selectores

            // **Actualizar la vista de combate para reflejar el nivel actualizado**
            if (charactersData.length > 0) {
                loadCharacterStats();
            }

            if (rewardResults.innerHTML) {
                alert(`Personaje ${character.name} actualizado a nivel ${newLevel} con ${expGain} EXP, ${goldGain} de oro y ${items.length} objetos nuevos.`);
            } else {
                alert(`Personaje ${character.name} actualizado a nivel ${newLevel}. No se generaron recompensas.`);
            }
        }


        function calculateLevel(totalExp) {
            for (let i = expData.length - 1; i >= 0; i--) {
                if (totalExp >= expData[i].totalExp) {
                    return expData[i].level;
                }
            }
            return 1; // Nivel mínimo si no cumple con ninguna experiencia
        }

        // Función para refrescar la vista de personajes
        function loadCharacterData() {
            const characterContainer = document.getElementById('characterContainer');
            characterContainer.innerHTML = ''; // Limpiar contenido existente

            charactersData.forEach(character => {
                const characterDiv = document.createElement('div');
                characterDiv.className = 'character';

                // Construir la lista de objetos
                const itemsList = character.inventory.items.map(item => `<li>${item}</li>`).join('');

                const characterInfo = `
                    <img src="${character.image}" alt="${character.name}">
                    <h2>${character.name}</h2>
                    <h3>Nivel: ${character.level}</h3> <!-- Aquí se muestra el nivel -->
                    <p><strong>Género:</strong> ${character.gender}</p>
                    <p><strong>Raza:</strong> ${character.race}</p>
                    <p><strong>Clase:</strong> ${character.class}</p>
                    <h3>Estadísticas</h3>
                    <ul class="stats">
                        <li><strong>VIT:</strong> ${character.stats.VIT}</li>
                        <li><strong>FUE:</strong> ${character.stats.FUE}</li>
                        <li><strong>DES:</strong> ${character.stats.DES}</li>
                        <li><strong>INT:</strong> ${character.stats.INT}</li>
                        <li><strong>CAR:</strong> ${character.stats.CAR}</li>
                    </ul>
                    <h3>Inventario</h3>
                    <ul class="inventory">
                        <li><strong>Oro:</strong> ${character.inventory.gold}</li>
                        <li><strong>Objetos:</strong><ul>${itemsList}</ul></li>
                    </ul>
                    <h3>Experiencia</h3>
                    <p>${character.xp}</p> <!-- Asegúrate de mostrar la XP -->
                `;

                characterDiv.innerHTML = characterInfo;
                characterContainer.appendChild(characterDiv);
            });
        }



        // Cargar estadísticas del personaje seleccionado
        function loadCharacterStats() {
            const characterName = document.getElementById('characterSelect').value;
            const character = charactersData.find(c => c.name === characterName);
            console.log("Personaje seleccionado:", characterName, character); // Log para verificar

            if (character) {
                document.getElementById('characterStats').innerHTML = generateStatsHtml(character, 'character');
            } else {
                document.getElementById('characterStats').innerHTML = '<p>No se encontró el personaje seleccionado.</p>';
            }
        }

        // Cargar estadísticas del enemigo seleccionado
        function loadEnemyStats() {
            const enemyName = document.getElementById('enemySelect').value;
            const enemy = enemiesData.find(e => e.name === enemyName);  // Encontrar enemigo por nombre
            console.log("Enemigo seleccionado:", enemyName, enemy);  // Log para verificar

            if (enemy) {
                document.getElementById('enemyStats').innerHTML = generateStatsHtml(enemy, 'enemy');
            } else {
                document.getElementById('enemyStats').innerHTML = '<p>No se encontró el enemigo seleccionado.</p>';
            }
        }

        function calculateModifier(statValue) {
            return Math.floor((statValue - 10) / 2);
        }

        // Generar HTML para las estadísticas
        function generateStatsHtml(entity, type) {
            // Definir el orden deseado de las estadísticas
            const statOrder = ['VIT', 'FUE', 'DES', 'INT', 'CAR'];

            // Mapear las estadísticas en el orden especificado
            const statInputs = statOrder.map(stat => {
                const statValue = entity.stats[stat];
                const modifier = calculateModifier(statValue);

                return `
                    <div>
                        <span>${stat}:</span>
                        <span id="${type}-${stat}-value">${statValue}</span>
                        <span id="${type}-${stat}-modifier">(${modifier >= 0 ? '+' : ''}${modifier})</span>
                        <input type="number" class="stat-input" id="${type}-${stat}" placeholder="0">
                    </div>
                `;
            }).join('');

            return `
                <h3>${entity.name} - ${entity.class || 'Enemigo'} - Nivel: ${entity.level}</h3>
                ${statInputs}
                <button class="update-button" onclick="updateStats('${entity.name}', '${type}')">Actualizar</button>
            `;
        }

        // Actualizar estadísticas
        function updateStats(name, type) {
            const entity = (type === 'character') ? charactersData.find(c => c.name === name) : enemiesData.find(e => e.name === name);
            console.log("Actualizando estadísticas para:", name, entity); // Log para verificar

            if (entity) {
                Object.keys(entity.stats).forEach(stat => {
                    const input = document.getElementById(`${type}-${stat}`);
                    const delta = parseInt(input.value) || 0;

                    // Actualizar la estadística del entity
                    entity.stats[stat] += delta;

                    // Actualizar el valor en el HTML
                    const statValueElement = document.getElementById(`${type}-${stat}-value`);
                    const newStatValue = entity.stats[stat];
                    statValueElement.innerText = newStatValue;

                    // Calcular y actualizar el modificador
                    const newModifier = calculateModifier(newStatValue);
                    const modifierElement = document.getElementById(`${type}-${stat}-modifier`);
                    modifierElement.innerText = `(${newModifier >= 0 ? '+' : ''}${newModifier})`;

                    // Limpiar el campo de texto
                    input.value = '';
                });
            } else {
                alert('Error: entidad no encontrada.');
            }
        }

        //----FUNCIONES PARA GENERAR RECOMEPNSAS ALEATORIAS-----
        document.addEventListener('DOMContentLoaded', function () {
            // Vincular eventos a botones
            const generateButton = document.getElementById('generateRewardButton');
            const closeButton = document.querySelector('.close');

            if (generateButton) {
                generateButton.addEventListener('click', openRewardPopup);
            } else {
                console.error("El botón de generar recompensas no se encontró.");
            }

            if (closeButton) {
                closeButton.addEventListener('click', closeRewardPopup);
            } else {
                console.error("El botón de cerrar no se encontró.");
            }
        });

        // Función para abrir la ventana de recompensas
        function openRewardPopup() {
            const rewardPopup = document.getElementById('rewardPopup');
            if (rewardPopup) {
                rewardPopup.classList.remove('hidden');
                rewardPopup.style.display = 'block'; // Asegúrate de que el display se cambie a block
            } else {
                console.error("No se pudo encontrar el elemento rewardPopup.");
            }
        }

        // Función para cerrar la ventana de recompensas
        function closeRewardPopup() {
            const rewardPopup = document.getElementById('rewardPopup');
            if (rewardPopup) {
                rewardPopup.classList.add('hidden');
                rewardPopup.style.display = 'none'; // Cambia display a none al cerrar
            } else {
                console.error("No se pudo encontrar el elemento rewardPopup.");
            }
        }


        // Función para generar recompensas aleatorias
        function generateRewards() {
            console.log("Función generateRewards llamada");

            const playerLevelInput = document.getElementById('playerLevel');
            const enemiesDefeatedInput = document.getElementById('enemiesDefeated');
            const isBossInput = document.getElementById('isBoss');

            if (!playerLevelInput || !enemiesDefeatedInput) {
                console.error("No se encontraron los elementos de entrada necesarios.");
                return;
            }

            const playerLevel = parseInt(playerLevelInput.value);
            const enemiesDefeated = parseInt(enemiesDefeatedInput.value);
            const isBoss = isBossInput.checked;

            if (isNaN(playerLevel) || isNaN(enemiesDefeated)) {
                alert("Por favor, ingrese valores válidos para el nivel del jugador y enemigos derrotados.");
                return;
            }

            // Cálculo de experiencia y oro
            const expPerEnemy = 75;
            const expBoss = 500;
            const goldPerEnemy = 25;
            const goldBoss = 250;

            let totalExp = enemiesDefeated * expPerEnemy;
            let totalGold = enemiesDefeated * goldPerEnemy;
            let numItems = Math.min(enemiesDefeated, 4); // Máximo de 4 objetos

            if (isBoss) {
                totalExp += expBoss;
                totalGold += goldBoss;
                numItems += 1; // Añadir un objeto adicional si es jefe
            }

            // Determinar el rango de nivel de objetos
            const levelRange = getLevelRange(playerLevel);

            // Obtener los objetos del archivo Excel
            fetch('items.xlsx')
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const itemsData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // Filtrar los objetos por nivel
                    const filteredItems = itemsData.filter(item => item[4] == levelRange);
                    console.log("Objetos filtrados:", filteredItems);

                    if (filteredItems.length === 0) {
                        document.getElementById('rewardResults').innerHTML = `<p>No se encontraron objetos para el nivel ${levelRange}.</p>`;
                        return;
                    }

                    // Seleccionar objetos aleatorios
                    const selectedItems = getRandomItems(filteredItems, numItems);
                    console.log("Objetos seleccionados:", selectedItems);

                    // Mostrar resultados
                    const resultsContainer = document.getElementById('rewardResults');
                    resultsContainer.innerHTML = `
                        <h3>Recompensa:</h3>
                        <p>${totalGold} de oro.</p>
                        <p>${totalExp} EXP</p>   
                        <h3>Objetos:</h3>
                        <ul>
                            ${selectedItems.map(item => `<li>${item[0]} - Nivel: ${item[4]}</li>`).join('')}
                        </ul>
                    `;
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                    document.getElementById('rewardResults').innerHTML = `<p>Error al cargar las recompensas. Verifique el archivo XLSX.</p>`;
                });
        }

        // Función para obtener el rango de nivel basado en el nivel del jugador
        function getLevelRange(playerLevel) {
            if (playerLevel < 5) {
                return 1;
            } else if (playerLevel >= 5 && playerLevel < 10) {
                return 5;         
            }else if (playerLevel >= 10 && playerLevel < 15) {
                return 10;
            } else if (playerLevel >= 15 && playerLevel < 20) {
                return 15;
            } else {
                return 20;
            }
        }

        // Función para seleccionar elementos aleatorios de una lista
        function getRandomItems(items, count) {
            const shuffled = items.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }



        function loadItems() {
            const url = 'items.xlsx'; // Cambia esto a la ruta de tu archivo

            fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const items = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    const tableBody = document.querySelector('#itemsTable tbody');
                    tableBody.innerHTML = ''; // Limpiar contenido existente

                    items.forEach((row, index) => {
                        if (index === 0) return; // Saltar la fila del encabezado

                        const tr = document.createElement('tr');
                        row.forEach((cell, cellIndex) => {
                            const td = document.createElement('td');
                            td.textContent = cell;

                            // Añadir data-label para diseño responsivo
                            switch (cellIndex) {
                                case 0: td.setAttribute('data-label', 'Nombre del objeto'); break;
                                case 1: td.setAttribute('data-label', 'Descripción'); break;
                                case 2: td.setAttribute('data-label', 'Tipo de objeto'); break;
                                case 3: td.setAttribute('data-label', 'Precio (Oro)'); break;
                                case 4: td.setAttribute('data-label', 'Nivel'); break;
                                case 5: td.setAttribute('data-label', 'Clase'); break;
                            }

                            tr.appendChild(td);
                        });

                        tr.setAttribute('data-type', row[2]); // Asume que la tercera columna es el tipo
                        tr.setAttribute('data-level', row[4]); // Asume que la quinta columna es el nivel
                        tr.setAttribute('data-class', row[5]); // Asume que la sexta columna es la clase
                        tableBody.appendChild(tr);
                    });

                    itemsLoaded = true; // Marcamos que los objetos ya se han cargado
                    filterItems(); // Aplicamos el filtro al cargar datos
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                });
        }

        function resetFilters() {
            document.getElementById('itemFilter').value = 'all';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('classFilter').value = 'all';
            filterItems();
        }

        function filterItems() {
            const typeFilter = document.getElementById('itemFilter').value;
            const levelFilter = document.getElementById('levelFilter').value;
            const classFilter = document.getElementById('classFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#itemsTable tbody tr');

            rows.forEach(row => {
                const typeMatch = typeFilter === 'all' || row.getAttribute('data-type') === typeFilter;
                const levelMatch = levelFilter === 'all' || row.getAttribute('data-level') === levelFilter;
                const classMatch = classFilter === 'all' || row.getAttribute('data-class').toLowerCase().includes(classFilter);

                if (typeMatch && levelMatch && classMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function loadExp() {
			const url = 'exp.xlsx'; // Cambia esto a la ruta de tu archivo

			fetch(url)
				.then(response => response.arrayBuffer())
				.then(data => {
					const workbook = XLSX.read(data, {type: 'array'});
					const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
					const exp = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

					const tableBody = document.querySelector('#expTable tbody');
					tableBody.innerHTML = ''; // Clear existing content

					exp.forEach((row, index) => {
						if (index === 0) return; // Skip header row

						const tr = document.createElement('tr');
						row.forEach((cell, cellIndex) => {
							const td = document.createElement('td');
							td.textContent = cell;

							// Add data-label attribute for responsive design
							switch (cellIndex) {
								case 0: td.setAttribute('data-label', 'Nivel'); break;
								case 1: td.setAttribute('data-label', 'Experiencia Total'); break;
								case 2: td.setAttribute('data-label', 'Incremento de Experiencia'); break;
							}

							tr.appendChild(td);
						});
						tableBody.appendChild(tr);
					});
				})
				.catch(error => {
					console.error('Error al cargar el archivo XLS:', error);
				});
		}

        // SKILLS LOAD AND FILTERS

        function loadSkills() {
            const url = 'skills.xlsx'; // Cambia esto a la ruta de tu archivo

            fetch(url)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const skills = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    const tableBody = document.querySelector('#skillsTable tbody');
                    tableBody.innerHTML = ''; // Limpiar contenido existente

                    skills.forEach((row, index) => {
                        if (index === 0) return; // Saltar la fila del encabezado

                        const tr = document.createElement('tr');
                        row.forEach((cell, cellIndex) => {
                            const td = document.createElement('td');
                            td.textContent = cell;

                            // Add data-skill attribute for responsive design
                            switch (cellIndex) {
                                case 0: td.setAttribute('data-skill', 'Nombre de la habilidad'); break;
                                case 1: td.setAttribute('data-skill', 'Descripción'); break;
                                case 2: td.setAttribute('data-skill', 'Nivel'); break;
                                case 3: td.setAttribute('data-skill', 'Clase'); break;
                            }

                            tr.appendChild(td);
                        });

                        tr.setAttribute('data-class', row[3]); // Assume fourth column is the class
                        tableBody.appendChild(tr);
                    });

                    skillsLoaded = true; // Marcamos que las habilidades ya se han cargado
                    filterSkills(); // Aplicamos el filtro al cargar datos
                })
                .catch(error => {
                    console.error('Error al cargar el archivo XLS:', error);
                });
        }

		function filterSkills() {
            const skillFilter = document.getElementById('skillFilter').value.toLowerCase();
            const levelSkillFilter = document.getElementById('levelSkillFilter').value;
            const rows = document.querySelectorAll('#skillsTable tbody tr');

            rows.forEach(row => {
                const classMatch = skillFilter === 'all' || row.getAttribute('data-class').toLowerCase().includes(skillFilter);
                
                // Obtener el nivel de la habilidad
                const skillLevel = parseInt(row.cells[2].textContent); // Asume que la tercera columna es el nivel
                const levelMatch = levelSkillFilter === 'all' || skillLevel <= parseInt(levelSkillFilter);

                if (classMatch && levelMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function resetFiltersSkills() {
            document.getElementById('skillFilter').value = 'all';
            document.getElementById('levelSkillFilter').value = 'all'; // Restablecer el filtro de nivel
            filterSkills();
        }

        // Llamar a la función al cargar la página
        window.onload = function() {
            loadExpData(); // Cargar datos de experiencia
            loadSavedGame();
            openTab('load'); // Mantener el comportamiento original de abrir la pestaña de carga
            populateEditCharacterSelect(); // Poblamos el select al iniciar la aplicación
            loadEnemyData(); // Cargamos los datos de enemigos al iniciar la aplicación
        };

    </script>
</body>
</html>
